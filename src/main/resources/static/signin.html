<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Website - Sign In</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
    <section class="form__section">
        <div class="container form__section-container">
            <h2>Sign In</h2>
            
            <div id="alert-box" class="alert__message error" style="display: none;">
                <p id="alert-msg"></p>
            </div>

            <form onsubmit="handleLogin(event)">
                <input type="text" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn" id="submit-btn">Sign In</button>
                <small>Don't have an account? <a href="signup.html">Sign Up</a></small>
            </form>
        </div>
    </section>

    <script>
        const API_URL = "http://localhost:8080/api";

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const alertBox = document.getElementById("alert-box");
            const alertMsg = document.getElementById("alert-msg");
            const btn = document.getElementById("submit-btn");

            btn.innerText = "Signing In...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/auth/signin`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem("jwtToken", data.token);
                    localStorage.setItem("user", JSON.stringify({
                        id: data.id,
                        username: data.username,
                        email: data.email,
                        isAdmin: data.isAdmin,
                        avatar: data.avatar 
                    }));
                    
                    // Redirect to Home
                    window.location.href = "index.html";
                } else {
                    // Login Failed
                    alertBox.style.display = "block";
                    alertMsg.innerText = "Invalid Email or Password";
                    btn.innerText = "Sign In";
                    btn.disabled = false;
                }
            } catch (error) {
                alertBox.style.display = "block";
                alertMsg.innerText = "Server Error. Is backend running?";
                btn.innerText = "Sign In";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>